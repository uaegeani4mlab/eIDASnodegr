# eID WebApp

## Introduction

This project is comprised of a Java WebApp that streamlines and simplifies the integration of a Service Provider to the Greek PEPS node, in such a way that no
knowledge of the SAML  profile is required. Additionally, it provides pre-built UI for guiding the users through authentication flow.

It was developed by the "Information Management Lab (i4M Lab)", participant of the Atlantis Group (http://www.atlantis-group.gr/) of the University of the Aegean (https://www.aegean.gr/).

## Project Purpose

The WebApp complements the ISS PLUS functionality by containing a pre built UI that the SPs can use and also requires from the SPs to build less end points in order to retrieve the identification attributes from the authentication provider. The retrieved attributes get bundled together as a JWT token that arrives to the SP in the form of a cookie (auth_token).

Important Note: In order to use the WebApp  a fully functional instance of the ISS PLUS service must be deployed

## Deployment
First let us emphasize that the WebApp needs to be deployed in the same domain as the SP. This is required because the SP needs be able to retrieve the authentication token (that the WebApp generates) which is transferred as a cookie.

For the rest of this document we assume that the WebApp is to be deployed at http://www.host/com . Also, we assume that the WebApp will be available through the port 8090 of the hosting machine. Finally, we assume that the ISS PLUS instance is deployed at http://www.host.com/ISSPlus

### ISS PLUS integration

The WebApp exposes the following endpoints that need to be inserted as configuration parameters to the ISS PLUS instance (assuming the deployment parameters of the previous paragraph).
- http://www.host.com:8090/attributeList. This endpoint returns the list of attributes required by the SP which are queried by the ISS PLUS
- http://www.host.com:8090/issResponse. This endpoint parses and handles the response form the ISS PLUS
- http://www.host.com:8090/authsuccess. This endpoint handles the success redirection from ISS PLUS
- http://www.host.com:8090/authfail/. This endpoint handles the error redirection from ISS PLUS

Finally, upon setting up the integration with the ISS PLUS instance an SP identifier should be created for the WebApp.
For the rest of this document we assume that this identifier will be sp2.
For instructions on how these integration parameters are added to the ISS PLUS configuration please refer to  https://github.com/ellak-monades-aristeias/STORK2.0_ISSplus


### Docker Container Configuration

After configuring the ISS PLUS instance we are ready for the deployment of the WebApp. The configuration takes place using a config file (config.properties) that should reside in the folder /webappConfig.
```
EIDAS_PROPERTIES=list Of Attributes that will be requested from PEPS
SP_FAIL_PAGE= redirect url in case of failed authentication
SP_SUCCESS_PAGE=redirect url in case of successful authentication
ISS_URL= iss instance url
ISS_PRE_UR=  iss url for pre-production node, if available
SP_ID= ISS identifier for SP
SP_SECRET= secret shared between sp and DSS web app
AUTH_DURATION= duration for the authentication cookie in milliseconds
SP_LOGO=url for the logo of the sp to display in the UI
UAEGEAN_LOGIN= boolean, denotes wheter or not login using the UAegean idp should be an option
CLIENT_ID=linkedin ClientId
REDIRECT_URI=http://eideusmartclass.aegean.gr:9091/linkedInResponse
LINKED_IN_SECRET=linkedin secret
LINKED_IN=boolean, denotes wheter or not login using Linkedin should be an option
HTTP_HEADER=boolean, denotes if the generated JWT will be sent as an authentication header instead of the diffult method (cookie)
ASYNC_SIGNATURE=boolean, denotes if PKI should be used instead of symetric encryption of the JWT token
SP_JWT_CERT = path to private key keystore
SP_KEY_PASS = password for the certificate;
STORE_PASS = password for the keystore
CERT_ALIAS = name of the certificate in the keystore
```


### Integration
In order for the SP to interact with the WebApp it needs to follow the next steps (in the rest of this section we assume that the WebApp is deployed at http://www.host.com:8090):
- Upon authentication request, redirect the user to http://www.host.com:8090/login
- Build an endpoint (e.g. ) that the  WebApp will redirect to in case of authentication success
- (optionally) Build an endpoint that the WebApp will redirect to in case of authentication failure

The success and fail endpoints will consume a JSON Web Token (JWT) generated by the Thin WebApp delivered to the SP in the form of a cookie. JSON Web Tokens are an open, industry standard RFC 7519 method for representing claims securely between two parties. For this reason the WebApp needs to be deployed in the same domain as the SP. In the case of a successful authentication this token will contain the retrieved identification attributes of the user. In case of an authentication failure this token will contain the authentication error as that was returned by the ISS PLUS.
The generated authentication token is signed using HS256 (HMAC with SHA-256) with a secret shared between the SP and the WebApp. Upon receiving the token the SP should validate it and read the identification attributes from its payload.
